<?xml version="1.0"?>

<project name="yanel-main" default="deploy" xmlns:artifact="antlib:org.apache.maven.artifact.ant">

  <description>Yanel Build</description>

<!--
  <taskdef name="svn" classname="org.tigris.subversion.svnant.SvnTask"/>
  <svn failonerror="false">
    <status path="../../" lastChangedRevisionProperty="yanel.revision.svn"/>
  </svn>
  <condition property="yanel.revision" value="${yanel.revision.svn}">
   <not>
     <equals arg1="-1" arg2="${yanel.revision.svn}"/>
   </not>
  </condition>
-->
    
  <property file="local.build.properties"/>
  <property file="build.properties"/>
  <property name="yanel.source.home" value="${basedir}/../../"/>
<!--
  <echo>Yanel Revision: ${yanel.revision}</echo>
-->
    
  <condition property="isWindows">
   <os family="windows"/>
  </condition>
  
  <condition property="isUnix">
   <os family="unix"/>
  </condition>

  <import file="dependencies.xml"/>
  <import file="targets/continuous-integration/continuous-integration.xml"/>
  <import file="targets/install-tomcat.xml"/>
  <import file="targets/add-third-party-realm.xml"/>
  <import file="targets/create-new-resource-type.xml"/>
  <import file="targets/build-binary-snapshot.xml"/>
  <import file="targets/build-update-war.xml"/>
  <import file="targets/execute-jmeter.xml"/>
  <import file="targets/check-conf-version.xml"/>
  <import file="targets/clean.xml"/>
  <import file="targets/webapp/webapp.xml"/>
  <import file="targets/webapp/cluster.xml"/>
  <import file="targets/javadoc.xml"/>
  <import file="targets/resources.xml"/>
  <import file="targets/realms.xml"/>
  <import file="targets/cmdl.xml"/>
  <import file="targets/test.xml"/>
  <import file="targets/config.xml"/>
  

    
  <target name="init" description="Initialize all parameters and other settings">
    <echo>INFO: Building with ${ant.version} and Java version ${ant.java.version}</echo>

    <echo>Yanel Home Dir: ${yanel.source.home}</echo>
    <path id="yanel.source.home.ref">
      <pathelement location="${yanel.source.home}"/>
    </path>
    <pathconvert targetos="unix" property="yanel.source.home.forward.slashes" refid="yanel.source.home.ref">
    </pathconvert>

    <property name="build.dir" location="${yanel.source.home}/build"/>
    <mkdir dir="${build.dir}"/>
    <property name="classes.dir" location="${build.dir}/classes"/>
    <property name="log4j.path" location="${build.dir}/logs"/>
    <mkdir dir="${log4j.path}"/>
    <property name="log4j.file" location="${log4j.path}/log4j-cmdl.log"/>
    <path id="log4j.file.ref">
      <pathelement location="${log4j.file}"/>
    </path>
    <pathconvert targetos="unix" property="log4j.file.forward.slashes" refid="log4j.file.ref">
    </pathconvert>
<!--
    <echo>Log4j file with forward slashes: ${log4j.file.forward.slashes}</echo>
-->

<!--
<property name="default.tomcat.home.dir" value="${yanel.source.home}/local/apache-tomcat-${tomcat.version}"/>
-->
    <property name="default.tomcat.home.dir" location="${yanel.source.home}/local/apache-tomcat-${tomcat.version}"/>
    <path id="default.tomcat.home.dir.ref">
      <pathelement location="${default.tomcat.home.dir}"/>
    </path>
    <pathconvert targetos="unix" property="default.tomcat.home.dir.forward.slashes" refid="default.tomcat.home.dir.ref"/>
  </target>
    
  <target name="set-classpath" description="Set classpath" depends="init, dependencies">
    <echo>INFO: Set classpath ...</echo>
    <path id="classpath.compile">
      <!--
      <fileset dir="${yanel.source.home}/lib">
        <include name="*.jar"/>
      </fileset>
      -->
      <pathelement path="${maven2.cp}"/>
      <pathelement path="${maven2.compile.cp}"/>
    </path>
  </target>


  <target name="compile-core" description="Compile Java classes of Yanel core" depends="init, set-classpath">
    <mkdir dir="${classes.dir}"/>
    <javac srcdir="${yanel.source.home}/src/core/java/org/wyona/yanel/core"
      destdir="${classes.dir}"
      source="${source.java.version}"
      target="${target.java.version}"
      debug="true">
      <classpath refid="classpath.compile"/>
    </javac>
    <mkdir dir="${yanel.source.home}/build/lib"/>
    <jar destfile="${yanel.source.home}/build/lib/yanel-core-${yanel.version}-r${yanel.revision}.jar"
      basedir="${classes.dir}"
      includes="org/wyona/yanel/core/**"/>

    <copy file="${yanel.source.home}/src/build/pom-core.xml" todir="${yanel.source.home}/build/lib"/>
    <replace file="${yanel.source.home}/build/lib/pom-core.xml" value="${yanel.version}-r${yanel.revision}">
      <replacetoken>@VERSION@</replacetoken>
    </replace>

    <artifact:pom id="core.project" file="${yanel.source.home}/build/lib/pom-core.xml"/>

    <artifact:install file="${yanel.source.home}/build/lib/yanel-core-${yanel.version}-r${yanel.revision}.jar">
      <pom refid="core.project"/>
    </artifact:install>
  </target>

  <target name="compile-impl" description="Compile Java classes of Yanel implementation" depends="init">
    <mkdir dir="${classes.dir}"/>
    <javac srcdir="${yanel.source.home}/src/impl/java/org/wyona/yanel/impl" destdir="${classes.dir}" debug="true">
      <classpath refid="classpath.compile"/>
    </javac>

    <mkdir dir="${yanel.source.home}/build/lib"/>
    <jar destfile="${yanel.source.home}/build/lib/yanel-impl-${yanel.version}-r${yanel.revision}.jar"
      basedir="${classes.dir}"
      includes="org/wyona/yanel/impl/**"/>
      
    <copy file="${yanel.source.home}/src/build/pom-impl.xml" todir="${yanel.source.home}/build/lib"/>
    <replace file="${yanel.source.home}/build/lib/pom-impl.xml" value="${yanel.version}-r${yanel.revision}">
      <replacetoken>@VERSION@</replacetoken>
    </replace>

    <artifact:pom id="impl.project" file="${yanel.source.home}/build/lib/pom-impl.xml"/>

    <artifact:install file="${yanel.source.home}/build/lib/yanel-impl-${yanel.version}-r${yanel.revision}.jar">
      <pom refid="impl.project"/>
    </artifact:install>      
  </target>

  <target name="source-snapshot" description="Create a source code snapshot" depends="init, clean-all">
    <delete dir="${build.dir}/source-snapshots"/>
    <property name="snapshot.dir" value="${build.dir}/source-snapshots/wyona-yanel-SNAPSHOT-${yanel.version}-r${yanel.revision}-src"/>
    <mkdir dir="${snapshot.dir}/src"/>
    <copy file="${yanel.source.home}/README.txt" todir="${snapshot.dir}"/>
    <copy file="${yanel.source.home}/configure.sh" todir="${snapshot.dir}"/>
    <chmod file="${snapshot.dir}/configure.sh" perm="755"/>
    <copy file="${yanel.source.home}/configure.bat" todir="${snapshot.dir}"/>
    <copy file="${yanel.source.home}/build.sh" todir="${snapshot.dir}"/>
    <chmod file="${snapshot.dir}/build.sh" perm="755"/>
    <copy file="${yanel.source.home}/build.bat" todir="${snapshot.dir}"/>
    <copy file="${yanel.source.home}/yanel.sh" todir="${snapshot.dir}"/>
    <chmod file="${snapshot.dir}/yanel.sh" perm="755"/>
    <copy file="${yanel.source.home}/yanel.bat" todir="${snapshot.dir}"/>
    <copy todir="${snapshot.dir}/src">
      <fileset dir="${yanel.source.home}/src" excludes="build/local.build.properties, contributions/resources/nutch/conf/nutch-local.xml"/>
    </copy>
    <copy todir="${snapshot.dir}/tools">
      <fileset dir="${yanel.source.home}/tools"/>
    </copy>
    <chmod dir="${snapshot.dir}/tools/apache-ant-1.6.5/bin" perm="755" includes="*"/>
    <copy todir="${snapshot.dir}/conf">
      <fileset dir="${yanel.source.home}/conf" excludes="local/**"/>
    </copy>
    <zip destfile="${build.dir}/source-snapshots/wyona-yanel-SNAPSHOT-${yanel.version}-r${yanel.revision}-src.zip">
      <zipfileset dir="${build.dir}/source-snapshots/wyona-yanel-SNAPSHOT-${yanel.version}-r${yanel.revision}-src" prefix="wyona-yanel-SNAPSHOT-${yanel.version}-r${yanel.revision}-src" filemode="755"/>
    </zip>
  </target>
  
  <target name="final-message">
    <echo/>
    <echo/>
    <echo message="*****************************************************************"/>
    <echo message="*"/>
    <echo message="* You have successfully built Yanel ${yanel.version} (Revision ${yanel.revision})"/>
    <echo message="*"/>
    <echo message="*"/>
    <echo message="* Start using Yanel by typing"/>
    <echo message="*"/>
    <if>
     <equals arg1="${isWindows}" arg2="true" />
     <then>
       <echo message="*      Tomcat:      yanel start"/>
     </then>
    </if>
    <if>
     <equals arg1="${isUnix}" arg2="true" />
     <then>
       <echo  message="*      Tomcat:    ./yanel.sh start"/>
     </then>
    </if>
    <echo message="*"/>
    <echo message="*                   and browse to "/>
    <echo message="*"/>
    <echo message="*                   http://127.0.0.1:8080/${servlet.context.prefix}/"/>
    <echo message="*"/>
<!--
    <echo message="*      Jetty:       yanel start-jetty"/> 
    <echo message="*"/>
    <echo message="*                   and browse to "/>
    <echo message="*"/> 
    <echo message="*                   http://127.0.0.1:8888"/>
-->
    <echo message="*"/>
    <echo message="* Thanks for using Yanel"/>
    <echo message="*"/>
    <echo message="*****************************************************************"/>
  </target>

</project>
